<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Programme Musculation & Calisthénie - Suivi Graphique</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-btn.active { background-color: #3b82f6; color: white; }
        .tab-btn.suivi.active { background-color: #16a34a; color: white; }
        .tab-btn.dernier.active { background-color: #ca8a04; color: white; }
        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }
        .accordion-toggle svg, .exercise-graph-toggle svg {
            transition: transform 0.2s ease-in-out;
        }
        .accordion-toggle.open svg, .exercise-graph-toggle.open svg {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-900">Votre Programme Hebdomadaire</h1>
            <p class="text-xl text-blue-600 mt-2">Format 3 Jours : Tirage / Poussée / Jambes</p>
        </header>

        <main class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
            <!-- Tabs de navigation -->
            <div class="mb-6 border-b border-gray-200">
                <nav class="flex flex-wrap -mb-px" id="tabs">
                    <button class="tab-btn active text-lg font-semibold py-3 px-4 md:px-6 rounded-t-lg mr-2" data-tab="tirage">Tirage</button>
                    <button class="tab-btn text-lg font-semibold py-3 px-4 md:px-6 rounded-t-lg mr-2" data-tab="poussee">Poussée</button>
                    <button class="tab-btn text-lg font-semibold py-3 px-4 md:px-6 rounded-t-lg" data-tab="jambes">Jambes</button>
                    <div class="ml-auto flex flex-wrap">
                        <button class="tab-btn dernier text-lg font-semibold py-3 px-4 md:px-6 rounded-t-lg mr-2 border border-yellow-500 text-yellow-600 hover:bg-yellow-50" data-tab="dernieres-seances">Dernières Séances</button>
                        <button class="tab-btn suivi text-lg font-semibold py-3 px-4 md:px-6 rounded-t-lg border border-green-500 text-green-600 hover:bg-green-50" data-tab="suivi">Suivi Graphique</button>
                    </div>
                </nav>
            </div>

            <!-- Contenu des jours et du suivi -->
            <div id="tab-contents">
                <!-- SÉANCE TIRAGE -->
                <div id="tirage" class="tab-content active">
                    <h3 class="text-3xl font-bold mb-4 text-gray-900">Séance 1 : Tirage (Dos, Biceps)</h3>
                     <div id="tirage-exercises" class="space-y-6">
                        <!-- Les exercices sont maintenant générés par JavaScript -->
                     </div>
                </div>

                <!-- SÉANCE POUSSÉE -->
                <div id="poussee" class="tab-content">
                     <h3 class="text-3xl font-bold mb-4">Séance 2 : Poussée</h3>
                     <div id="poussee-exercises" class="space-y-6">
                        <!-- Les exercices sont maintenant générés par JavaScript -->
                     </div>
                </div>

                <!-- SÉANCE JAMBES -->
                <div id="jambes" class="tab-content">
                     <h3 class="text-3xl font-bold mb-4">Séance 3 : Jambes & Core</h3>
                     <div id="jambes-exercises" class="space-y-6">
                        <!-- Les exercices sont maintenant générés par JavaScript -->
                     </div>
                </div>
                
                <!-- Onglet Dernières Séances -->
                <div id="dernieres-seances" class="tab-content">
                    <h3 class="text-3xl font-bold mb-4 text-yellow-700">Détail des Dernières Séances</h3>
                    <div id="dernieres-seances-content" class="space-y-8">
                        <!-- Le contenu sera généré par JS -->
                    </div>
                </div>

                <!-- Onglet Suivi Graphique -->
                <div id="suivi" class="tab-content">
                    <h3 class="text-3xl font-bold mb-4 text-green-700">Suivi Graphique de Progression</h3>
                    <p class="mb-6 text-gray-600">Cliquez sur un type de séance pour voir les exercices, puis sur un exercice pour afficher son graphique.</p>
                    <div id="suivi-graphs-content" class="space-y-4">
                        <!-- Les accordéons de graphiques seront générés par JS -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Charger le fichier de base de données AVANT le script principal -->
    <script src="database.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
        // --- GESTION DES DONNÉES ---
        // MODIFIÉ: On utilise directement les objets, plus besoin de la fonction loadData
        let data = mockData;
        const chartInstances = {};

        // --- GESTION DU MODAL ---
        const modal = document.getElementById('performance-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const savePerfBtn = document.getElementById('save-performance-btn');
        const modalTitle = document.getElementById('modal-title');
        const modalExoName = document.getElementById('modal-exercise-name');
        const modalRepsInput = document.getElementById('modal-reps');
        const modalWeightInput = document.getElementById('modal-weight');
        const modalWorkoutTypeInput = document.getElementById('modal-workout-type');

        // NOUVEAU: Fonction pour ouvrir le modal
        function openPerformanceModal(exerciseName, workoutType) {
            modalExoName.textContent = exerciseName;
            modalTitle.textContent = `Ajouter Performance pour ${exerciseName}`;
            modalWorkoutTypeInput.value = workoutType; // Stocke le type de séance
            modal.classList.remove('hidden');
        }

        // NOUVEAU: Fonction pour fermer le modal
        function closePerformanceModal() {
            modal.classList.add('hidden');
            modalRepsInput.value = '';
            modalWeightInput.value = '0';
        }
        
        // NOUVEAU: Fonction pour sauvegarder la performance d'un exercice (temporairement)
        function saveExercisePerformance() {
            const exerciseName = modalExoName.textContent;
            const workoutType = modalWorkoutTypeInput.value;
            
            const reps = modalRepsInput.value.split(',').map(r => parseInt(r.trim())).filter(r => !isNaN(r));
            const weight = parseFloat(modalWeightInput.value);

            if (reps.length === 0) {
                alert("Veuillez entrer au moins une répétition valide.");
                return;
            }

            const newPerformance = {
                name: exerciseName,
                sets: reps.length,
                reps: reps,
                weight: weight
            };
            
            // On cherche si l'exercice a déjà été enregistré dans la séance en cours pour le remplacer
            const existingIndex = currentSession[workoutType].findIndex(ex => ex.name === exerciseName);
            if(existingIndex > -1) {
                currentSession[workoutType][existingIndex] = newPerformance;
            } else {
                currentSession[workoutType].push(newPerformance);
            }

            console.log("Séance en cours:", currentSession);
            alert(`Performance pour "${exerciseName}" ajoutée à la séance en cours !`);
            closePerformanceModal();
        }
        
        // NOUVEAU: Fonction pour finaliser et enregistrer la séance
        function finalizeAndSaveSession(workoutType) {
            if (currentSession[workoutType].length === 0) {
                alert("Aucune performance n'a été ajoutée pour cette séance.");
                return;
            }

            const newSession = {
                date: new Date().toISOString().split('T')[0], // Date du jour
                type: workoutType,
                exercises: currentSession[workoutType]
            };

            data.workout_log.push(newSession);

            // Réinitialiser la séance en cours
            currentSession[workoutType] = [];

            // Mettre à jour toute l'interface
            renderProgram();
            renderLastSessions();
            renderGraphs();

            alert(`Séance de ${workoutType} enregistrée avec succès !`);
            
            // Proposer l'export
            showExportModal();
        }
        
        // NOUVEAU: Fonction pour afficher le modal d'exportation
        function showExportModal() {
            const exportTextarea = document.getElementById('export-textarea');
            // On doit reconstruire le code complet du fichier database.js
            const newDbContent = `const program = ${JSON.stringify(program, null, 4)};\n\nconst mockData = ${JSON.stringify(data, null, 4)};\n\nlet currentSession = {\n    "Tirage": [],\n    "Poussée": [],\n    "Jambes": []\n};`;
            exportTextarea.value = newDbContent;
            document.getElementById('export-modal').classList.remove('hidden');
        }


        // --- AFFICHAGE ---

        // MODIFIÉ: renderProgram pour ajouter le bouton "Ajouter performance"
        function renderProgram() {
            const workoutTypes = {
                "tirage": "Tirage",
                "poussee": "Poussée",
                "jambes": "Jambes"
            };

            function getLastPerformance(exerciseName) {
                const history = data.workout_log
                    .flatMap(session => session.exercises.map(ex => ({ ...ex, date: session.date })))
                    .filter(ex => ex.name === exerciseName)
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
                return history.length > 0 ? history[0] : null;
            }

            for (const [typeKey, typeName] of Object.entries(workoutTypes)) {
                const container = document.getElementById(`${typeKey}-exercises`);
                if (!container) continue;
                container.innerHTML = ''; 

                program[typeKey].forEach(exercise => {
                    const lastPerf = getLastPerformance(exercise.name);
                    let lastPerfHtml = '<p class="text-sm text-gray-500 italic mt-2">Aucune donnée précédente.</p>';

                    if (lastPerf) {
                        if (lastPerf.weight > 0) {
                            lastPerfHtml = `<p class="text-sm text-blue-600 font-semibold mt-2">Dernière séance : ${lastPerf.weight} kg</p>`;
                        } else {
                            const repsStr = lastPerf.reps.join(' - ');
                            lastPerfHtml = `<p class="text-sm text-blue-600 font-semibold mt-2">Dernière séance : ${lastPerf.sets} séries de [${repsStr}] reps</p>`;
                        }
                    }

                    // MODIFIÉ: Ajout du bouton d'ajout de performance
                    const exerciseHtml = `
                        <div class="p-4 bg-gray-50 rounded-lg">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="font-bold text-lg">${exercise.name}</h4>
                                    <p class="font-semibold mt-1">${exercise.sets} séries de ${exercise.reps} répétitions</p>
                                </div>
                                <span class="text-xs font-medium text-gray-600 bg-gray-200 px-2 py-1 rounded-full whitespace-nowrap">${exercise.rest_time}</span>
                            </div>
                            ${lastPerfHtml}
                            <button class="add-performance-btn mt-3 w-full text-sm font-semibold text-blue-600 bg-blue-100 hover:bg-blue-200 py-2 px-4 rounded-md transition"
                                    data-exercise-name="${exercise.name}" data-workout-type="${typeName}">
                                Ajouter la performance du jour
                            </button>
                        </div>
                    `;
                    container.innerHTML += exerciseHtml;
                });
                
                // NOUVEAU: Ajout du bouton pour finaliser la séance
                container.innerHTML += `
                    <div class="mt-8">
                        <button class="finalize-session-btn w-full py-3 px-4 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700 transition"
                                data-workout-type="${typeName}">
                            Terminer et Enregistrer la Séance ${typeName}
                        </button>
                    </div>
                `;
            }
        }

        function renderLastSessions() {
            const container = document.getElementById('dernieres-seances-content');
            container.innerHTML = '';
            const workoutTypes = ['Tirage', 'Poussée', 'Jambes'];

            workoutTypes.forEach(type => {
                const sessionsOfType = data.workout_log.filter(s => s.type === type)
                                                .sort((a,b) => new Date(b.date) - new Date(a.date));

                const div = document.createElement('div');
                let content = `<h4 class="text-2xl font-semibold border-b pb-2 mb-3">${type}</h4>`;

                if (sessionsOfType.length > 0) {
                    const lastSession = sessionsOfType[0];
                    content += `
                        <div class="p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                            <p class="font-bold text-yellow-800">Dernière séance le ${new Date(lastSession.date).toLocaleDateString('fr-FR')}</p>
                            <ul class="list-disc list-inside mt-2 text-gray-700">`;
                    
                    lastSession.exercises.forEach(ex => {
                        const repsStr = ex.reps.join(', ');
                        const weightStr = ex.weight > 0 ? `à ${ex.weight} kg` : `(Poids du corps)`;
                        content += `<li><strong>${ex.name}:</strong> ${ex.sets} séries de [${repsStr}] reps ${weightStr}</li>`;
                    });

                    content += `</ul></div>`;
                } else {
                    content += `<div class="text-gray-500 italic">Aucune séance de type "${type}" enregistrée.</div>`;
                }
                div.innerHTML = content;
                container.appendChild(div);
            });
        }

        function renderGraphs() {
            const container = document.getElementById('suivi-graphs-content');
            container.innerHTML = '';
            // Détruire les anciens graphiques pour éviter les fuites de mémoire
            for (const chartId in chartInstances) {
                if (chartInstances[chartId]) {
                    chartInstances[chartId].destroy();
                    delete chartInstances[chartId];
                }
            }
            
            const workoutTypes = ['Tirage', 'Poussée', 'Jambes'];

            workoutTypes.forEach(type => {
                const accordion = document.createElement('div');
                accordion.className = 'border border-gray-200 rounded-lg';
                
                const exercisesForType = [...new Set(
                    data.workout_log
                        .filter(session => session.type === type)
                        .flatMap(session => session.exercises.map(ex => ex.name))
                )];

                if (exercisesForType.length === 0) return;

                let exercisesHtml = '<div class="space-y-2">';
                exercisesForType.forEach(exerciseName => {
                    const chartId = `chart-${exerciseName.replace(/[^a-zA-Z0-9]/g, '-')}`;
                    exercisesHtml += `
                        <div>
                            <button class="exercise-graph-toggle w-full text-left p-3 rounded-lg bg-gray-50 hover:bg-gray-100 focus:outline-none transition duration-150 ease-in-out flex justify-between items-center" data-exercise="${exerciseName}" data-chart-id="${chartId}">
                                <span class="font-semibold text-gray-700">${exerciseName}</span>
                                <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                            <div id="wrapper-${chartId}" class="chart-wrapper hidden mt-2 pl-4 pr-4 pb-2">
                                <div class="chart-container bg-white p-2 rounded-md">
                                    <canvas id="${chartId}"></canvas>
                                </div>
                            </div>
                        </div>
                    `;
                });
                exercisesHtml += '</div>';

                accordion.innerHTML = `
                    <button class="accordion-toggle flex justify-between items-center w-full p-4 bg-gray-100 hover:bg-gray-200 rounded-t-lg">
                        <span class="text-xl font-bold text-gray-800">${type}</span>
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div class="accordion-content hidden p-4 border-t border-gray-200">
                        ${exercisesHtml}
                    </div>
                `;
                container.appendChild(accordion);
            });
        }

        function createChart(exerciseName, chartId) {
            if (chartInstances[chartId]) {
                chartInstances[chartId].destroy(); // Détruire l'ancien graphique s'il existe
            }

            const exerciseHistory = data.workout_log
                .flatMap(session => session.exercises.map(ex => ({...ex, date: session.date})))
                .filter(ex => ex.name === exerciseName)
                .sort((a,b) => new Date(a.date) - new Date(b.date));

            if (exerciseHistory.length < 2) {
                const wrapper = document.getElementById(`wrapper-${chartId}`);
                wrapper.innerHTML = '<p class="text-center text-gray-500">Pas assez de données pour afficher un graphique.</p>';
                return;
            };

            const labels = exerciseHistory.map(ex => new Date(ex.date).toLocaleDateString('fr-FR'));
            const isBodyweight = exerciseHistory.every(ex => ex.weight === 0);
            
            let chartData;
            let chartLabel;

            if (isBodyweight) {
                chartLabel = 'Répétitions totales';
                chartData = exerciseHistory.map(ex => ex.reps.reduce((total, rep) => total + rep, 0));
            } else {
                chartLabel = 'Poids (kg)';
                chartData = exerciseHistory.map(ex => ex.weight);
            }

            const ctx = document.getElementById(chartId).getContext('2d');
            chartInstances[chartId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: chartLabel,
                        data: chartData,
                        borderColor: '#16a34a',
                        backgroundColor: 'rgba(22, 163, 74, 0.1)',
                        fill: true,
                        tension: 0.2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { 
                        y: { 
                            beginAtZero: false,
                            title: { display: true, text: chartLabel }
                        } 
                    }
                }
            });
        }

        // --- GESTION DES ÉVÉNEMENTS ---

        // MODIFIÉ: event listener global pour les boutons créés dynamiquement
        document.body.addEventListener('click', (e) => {
            // Clic sur "Ajouter la performance du jour"
            if (e.target.classList.contains('add-performance-btn')) {
                const exerciseName = e.target.dataset.exerciseName;
                const workoutType = e.target.dataset.workoutType;
                openPerformanceModal(exerciseName, workoutType);
            }
            
            // Clic sur "Terminer et Enregistrer la Séance"
            if (e.target.classList.contains('finalize-session-btn')) {
                const workoutType = e.target.dataset.workoutType;
                finalizeAndSaveSession(workoutType);
            }
        });

        closeModalBtn.addEventListener('click', closePerformanceModal);
        savePerfBtn.addEventListener('click', saveExercisePerformance);

        document.getElementById('suivi-graphs-content').addEventListener('click', (e) => {
            const accordionToggle = e.target.closest('.accordion-toggle');
            if (accordionToggle) {
                accordionToggle.classList.toggle('open');
                const content = accordionToggle.nextElementSibling;
                content.classList.toggle('hidden');
                return;
            }

            const exerciseToggle = e.target.closest('.exercise-graph-toggle');
            if (exerciseToggle) {
                exerciseToggle.classList.toggle('open');
                const exerciseName = exerciseToggle.dataset.exercise;
                const chartId = exerciseToggle.dataset.chartId;
                const wrapper = document.getElementById(`wrapper-${chartId}`);
                
                // On s'assure que le contenu du wrapper est bien un canvas avant de créer le chart
                if (!wrapper.querySelector('canvas')) {
                    wrapper.querySelector('.chart-container').innerHTML = `<canvas id="${chartId}"></canvas>`;
                }
                createChart(exerciseName, chartId);
                
                wrapper.classList.toggle('hidden');
            }
        });

        const tabs = document.getElementById('tabs');
        const tabContents = document.getElementById('tab-contents');

        tabs.addEventListener('click', (e) => {
            const target = e.target;
            if (target.classList.contains('tab-btn')) {
                tabs.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                tabContents.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

                target.classList.add('active');
                const tabId = target.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
            }
        });

        // --- INITIALISATION ---
        renderProgram();
        renderLastSessions();
        renderGraphs();
    });
    </script>

    <div id="performance-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center">
        <div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Ajouter Performance</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500 mb-4" id="modal-exercise-name"></p>
                    
                    <input type="hidden" id="modal-workout-type">

                    <div class="mb-4">
                        <label for="modal-reps" class="text-left block text-sm font-medium text-gray-700">Répétitions par série (séparées par des virgules)</label>
                        <input type="text" id="modal-reps" placeholder="ex: 12, 10, 8, 8" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div class="mb-4">
                        <label for="modal-weight" class="text-left block text-sm font-medium text-gray-700">Poids (en kg) - Laissez à 0 pour le poids du corps</label>
                        <input type="number" id="modal-weight" value="0" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>

                </div>
                <div class="items-center px-4 py-3">
                    <button id="save-performance-btn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300">
                        Enregistrer la performance
                    </button>
                    <button id="close-modal-btn" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300 focus:outline-none">
                        Annuler
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="export-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center">
        <div class="relative mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
             <h3 class="text-lg leading-6 font-medium text-gray-900">Copiez vos nouvelles données</h3>
             <p class="text-sm text-gray-600 mt-2 mb-4">Remplacez le contenu de votre fichier `database.js` par le code ci-dessous pour sauvegarder vos nouvelles séances.</p>
             <textarea id="export-textarea" readonly class="w-full h-64 font-mono text-xs bg-gray-100 p-2 border rounded"></textarea>
             <button onclick="document.getElementById('export-modal').classList.add('hidden')" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 w-full">Fermer</button>
        </div>
    </div>
</body>
</html>
