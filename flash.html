<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcards Coréen - Apprentissage Personnalisé</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .korean-font { font-family: 'Noto Sans KR', sans-serif; }
        .scene { perspective: 1000px; }
        .card {
            width: 100%;
            height: 100%;
            position: relative;
            cursor: pointer;
            transform-style: preserve-3d;
            transition: transform 0.6s, border-color 0.3s;
            border: 4px solid transparent;
        }
        .card.is-flipped { transform: rotateY(180deg); }
        .card__face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .card__face--front { background-color: #1f2937; color: #f9fafb; }
        .card__face--back { background-color: #374151; color: white; transform: rotateY(180deg); }
        
        .status-new { border-color: #6b7280; }
        .status-learning { border-color: #f59e0b; }
        .status-mastered { border-color: #22c55e; }

        #loader, #auth-overlay, .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(17, 24, 39, 0.95);
            display: flex; justify-content: center; align-items: center;
            z-index: 9999; flex-direction: column;
            transition: opacity 0.3s;
        }
        .spinner, .btn-loading::after {
            border: 4px solid rgba(255, 255, 255, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #f97316;
            animation: spin 1s ease infinite;
        }
        .btn-loading {
            position: relative;
            color: transparent !important;
        }
        .btn-loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin-top: -10px;
            margin-left: -10px;
            border-width: 2px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .review-mode-btn.active {
            background-color: #d97706;
            box-shadow: 0 0 15px rgba(245, 158, 11, 0.5);
        }
        .deck-btn.active {
            background-color: #ea580c;
            color: white;
        }
        .mobile-deck-nav {
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .mobile-deck-nav::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-900 flex items-center justify-center min-h-screen p-2 md:p-4">

    <!-- Écran de Connexion / Inscription -->
    <div id="auth-overlay">
        <div class="w-full max-w-sm p-8 bg-gray-800 rounded-2xl shadow-xl">
            <h2 class="text-2xl font-bold text-center text-gray-100 mb-2">Flashcards Coréen</h2>
            <p class="text-center text-gray-400 mb-6">Connectez-vous pour sauvegarder votre progression.</p>
            <div id="auth-error" class="text-red-500 text-sm text-center mb-4 min-h-[20px]"></div>
            <form id="login-form" class="space-y-4">
                <input type="email" id="login-email" placeholder="Adresse e-mail" required class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 text-white">
                <input type="password" id="login-password" placeholder="Mot de passe" required class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 text-white">
                <button type="submit" class="w-full py-3 bg-orange-600 text-white font-bold rounded-lg hover:bg-orange-700 transition">Se connecter</button>
            </form>
            <div class="my-4 flex items-center"><hr class="w-full border-gray-600"><span class="p-2 text-gray-500 text-sm">OU</span><hr class="w-full border-gray-600"></div>
            <form id="signup-form" class="space-y-4">
                <input type="email" id="signup-email" placeholder="Adresse e-mail" required class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 text-white">
                <input type="password" id="signup-password" placeholder="Mot de passe (6 caractères min.)" required class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 text-white">
                <button type="submit" class="w-full py-3 bg-gray-600 text-white font-bold rounded-lg hover:bg-gray-500 transition">Créer un compte</button>
            </form>
        </div>
    </div>

    <!-- Indicateur de chargement -->
    <div id="loader" style="display: none;">
        <div class="spinner"></div>
        <p class="mt-4 text-lg font-semibold text-gray-300">Chargement...</p>
    </div>

    <!-- Contenu de l'application -->
    <div id="app-content" class="hidden w-full max-w-6xl mx-auto p-2 md:p-4 flex flex-col md:flex-row md:space-x-8">
        <aside class="w-full md:w-1/4 flex-shrink-0 mb-6 md:mb-0">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-300">Vos Paquets</h2>
                <button id="add-deck-btn" class="bg-orange-600 text-white rounded-full w-8 h-8 flex items-center justify-center hover:bg-orange-700 transition">+</button>
            </div>
            <div id="deck-sidebar-mobile" class="md:hidden flex space-x-2 pb-2 mobile-deck-nav"></div>
            <div id="deck-sidebar-desktop" class="hidden md:block space-y-2"></div>
        </aside>

        <main class="flex-grow">
            <header class="flex justify-between items-start mb-4">
                <h1 id="deck-title" class="text-2xl md:text-3xl font-bold text-orange-400"></h1>
                <div id="auth-info" class="text-right flex-shrink-0">
                    <p id="user-email" class="text-sm text-gray-500"></p>
                    <button id="logout-btn" class="text-xs text-red-500 font-bold hover:underline">Déconnexion</button>
                </div>
            </header>

            <div id="dashboard" class="flex justify-around bg-gray-800 p-3 rounded-lg mb-4 text-center">
                <div><p class="text-xl md:text-2xl font-bold text-green-500" id="mastered-count">0</p><p class="text-xs text-gray-400">Maîtrisé</p></div>
                <div><p class="text-xl md:text-2xl font-bold text-amber-500" id="learning-count">0</p><p class="text-xs text-gray-400">En cours</p></div>
                <div><p class="text-xl md:text-2xl font-bold text-gray-500" id="new-count">0</p><p class="text-xs text-gray-400">Nouveau</p></div>
            </div>
             <button id="add-card-btn" class="w-full mb-4 py-2 bg-gray-700 text-gray-200 font-semibold rounded-lg hover:bg-gray-600 transition">+ Ajouter une carte</button>

            <div class="scene h-56 md:h-64">
                <div id="flashcard" class="card rounded-xl">
                    <div id="card-front" class="card__face card__face--front"></div>
                    <div id="card-back" class="card__face card__face--back"></div>
                </div>
            </div>

            <p id="progress" class="text-center text-gray-500 mt-4"></p>

            <div id="status-buttons" class="flex justify-center space-x-3 mt-6">
                <button data-status="learning" class="status-btn flex-1 py-3 font-semibold text-white bg-amber-600 hover:bg-amber-700 rounded-lg transition">À revoir</button>
                <button data-status="mastered" class="status-btn flex-1 py-3 font-semibold text-white bg-green-600 hover:bg-green-700 rounded-lg transition">Maîtrisé</button>
            </div>

            <div class="flex justify-between items-center mt-4">
                <button id="prev-btn" class="bg-gray-700 text-gray-200 font-semibold py-2 px-4 md:px-6 rounded-lg shadow-md hover:bg-gray-600 transition disabled:opacity-50">Précédent</button>
                <button id="review-mode-btn" class="review-mode-btn bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg transition">Révision Intelligente</button>
                <button id="next-btn" class="bg-orange-600 text-white font-semibold py-2 px-4 md:px-6 rounded-lg shadow-md hover:bg-orange-700 transition">Suivant</button>
            </div>
        </main>
    </div>
    
    <!-- Modal pour ajouter un paquet -->
    <div id="add-deck-modal" class="modal-overlay hidden">
        <div class="w-full max-w-sm p-8 bg-gray-800 rounded-2xl shadow-xl space-y-4">
            <h3 class="text-xl font-bold text-center text-white">Nouveau Paquet</h3>
            <input type="text" id="new-deck-name" placeholder="Nom du paquet" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 text-white">
            <div class="flex space-x-4">
                <button id="save-deck-btn" class="w-full py-2 bg-orange-600 text-white font-bold rounded-lg hover:bg-orange-700 transition">Créer</button>
                <button id="cancel-deck-btn" class="w-full py-2 bg-gray-600 text-white font-bold rounded-lg hover:bg-gray-500 transition">Annuler</button>
            </div>
        </div>
    </div>
    
    <!-- Modal pour ajouter une carte -->
    <div id="add-card-modal" class="modal-overlay hidden">
        <div class="w-full max-w-sm p-8 bg-gray-800 rounded-2xl shadow-xl space-y-4">
            <h3 class="text-xl font-bold text-center text-white">Nouvelle Carte</h3>
            <input type="text" id="new-card-french" placeholder="Français" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 text-white">
            <input type="text" id="new-card-hangul" placeholder="Coréen (Hangeul)" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 text-white">
            <input type="text" id="new-card-romanization" placeholder="Romanisation" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 text-white">
            <div class="flex space-x-4">
                <button id="save-card-btn" class="w-full py-2 bg-orange-600 text-white font-bold rounded-lg hover:bg-orange-700 transition">Sauvegarder</button>
                <button id="cancel-card-btn" class="w-full py-2 bg-gray-600 text-white font-bold rounded-lg hover:bg-gray-500 transition">Annuler</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de confirmation de suppression -->
    <div id="delete-deck-modal" class="modal-overlay hidden">
        <div class="w-full max-w-sm p-8 bg-gray-800 rounded-2xl shadow-xl space-y-4 text-center">
            <h3 class="text-xl font-bold text-white">Confirmer la suppression</h3>
            <p class="text-gray-300">Êtes-vous sûr de vouloir supprimer ce paquet et toutes ses cartes ? Cette action est irréversible.</p>
            <div class="flex space-x-4">
                <button id="confirm-delete-deck-btn" class="w-full py-2 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition">Supprimer</button>
                <button id="cancel-delete-deck-btn" class="w-full py-2 bg-gray-600 text-white font-bold rounded-lg hover:bg-gray-500 transition">Annuler</button>
            </div>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, writeBatch, query, getDocs, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBKR5xMIcH89Pn5ktjtepRGQNWe6Dd_PsU",
            authDomain: "muscu-5e40c.firebaseapp.com",
            projectId: "muscu-5e40c",
            storageBucket: "muscu-5e40c.appspot.com",
            messagingSenderId: "561788112947",
            appId: "1:561788112947:web:7f2b7c7d74ff328f2b1346"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getFirestore(app);

        const defaultDecks = {
            'days': {
                name: 'Jours',
                cards: [
                    { id: 'day1', french: 'Lundi', hangul: '월요일', romanization: 'Woryoil' }, { id: 'day2', french: 'Mardi', hangul: '화요일', romanization: 'Hwayoil' },
                    { id: 'day3', french: 'Mercredi', hangul: '수요일', romanization: 'Suyoil' }, { id: 'day4', french: 'Jeudi', hangul: '목요일', romanization: 'Mogyoil' },
                    { id: 'day5', french: 'Vendredi', hangul: '금요일', romanization: 'Geumyoil' }, { id: 'day6', french: 'Samedi', hangul: '토요일', romanization: 'Toyoil' },
                    { id: 'day7', french: 'Dimanche', hangul: '일요일', romanization: 'Iryoil' }
                ]
            },
            'numbers_1_10': {
                name: 'Chiffres 1-10',
                cards: [
                    { id: 'num1', french: 'Un', hangul: '하나', romanization: 'Hana' }, { id: 'num2', french: 'Deux', hangul: '둘', romanization: 'Dul' },
                    { id: 'num3', french: 'Trois', hangul: '셋', romanization: 'Set' }, { id: 'num4', french: 'Quatre', hangul: '넷', romanization: 'Net' },
                    { id: 'num5', french: 'Cinq', hangul: '다섯', romanization: 'Daseot' }, { id: 'num6', french: 'Six', hangul: '여섯', romanization: 'Yeoseot' },
                    { id: 'num7', french: 'Sept', hangul: '일곱', romanization: 'Ilgop' }, { id: 'num8', french: 'Huit', hangul: '여덟', romanization: 'Yeodeol' },
                    { id: 'num9', french: 'Neuf', hangul: '아홉', romanization: 'Ahop' }, { id: 'num10', french: 'Dix', hangul: '열', romanization: 'Yeol' }
                ]
            },
            'numbers_key': {
                name: 'Nombres Clés',
                cards: [
                    { id: 'keynum1', french: 'Dix (sino)', hangul: '십', romanization: 'Sip' },
                    { id: 'keynum2', french: 'Vingt', hangul: '이십', romanization: 'Isip' },
                    { id: 'keynum3', french: 'Trente', hangul: '삼십', romanization: 'Samsip' },
                    { id: 'keynum4', french: 'Cent', hangul: '백', romanization: 'Baek' },
                    { id: 'keynum5', french: 'Mille', hangul: '천', romanization: 'Cheon' },
                    { id: 'keynum6', french: 'Dix Mille', hangul: '만', romanization: 'Man' }
                ]
            },
            'pronouns': {
                name: 'Pronoms',
                cards: [
                    { id: 'pro1', french: 'Je (Informel)', hangul: '나', romanization: 'Na' },
                    { id: 'pro2', french: 'Je (Formel)', hangul: '저', romanization: 'Jeo' },
                    { id: 'pro3', french: 'Tu (Informel)', hangul: '너', romanization: 'Neo' },
                    { id: 'pro4', french: 'Il / Lui', hangul: '그', romanization: 'Geu' },
                    { id: 'pro5', french: 'Elle', hangul: '그녀', romanization: 'Geunyeo' },
                    { id: 'pro6', french: 'Nous (Inclusif)', hangul: '우리', romanization: 'Uri' },
                    { id: 'pro7', french: 'Nous (Formel)', hangul: '저희', romanization: 'Jeohui' },
                    { id: 'pro8', french: 'Vous (Groupe)', hangul: '여러분', romanization: 'Yeoreobun' },
                    { id: 'pro9', french: 'Ils / Eux', hangul: '그들', romanization: 'Geudeul' },
                    { id: 'pro10', french: 'Elles', hangul: '그녀들', romanization: 'Geunyeodeul' }
                ]
            }
        };

        let userDecks = {};
        let currentDeckId = null;
        let currentCardIndex = 0;
        let isReviewMode = false;
        let visibleCards = [];

        const loader = document.getElementById('loader');
        const authOverlay = document.getElementById('auth-overlay');
        const appContent = document.getElementById('app-content');
        const card = document.getElementById('flashcard');
        const cardFront = document.getElementById('card-front');
        const cardBack = document.getElementById('card-back');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const progressText = document.getElementById('progress');
        const deckSidebarDesktop = document.getElementById('deck-sidebar-desktop');
        const deckSidebarMobile = document.getElementById('deck-sidebar-mobile');
        const deckTitle = document.getElementById('deck-title');
        const reviewModeBtn = document.getElementById('review-mode-btn');
        const addDeckModal = document.getElementById('add-deck-modal');
        const addCardModal = document.getElementById('add-card-modal');
        const deleteDeckModal = document.getElementById('delete-deck-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-deck-btn');

        onAuthStateChanged(auth, user => {
            if (user) {
                authOverlay.style.display = 'none';
                appContent.classList.add('hidden');
                loader.style.display = 'flex';
                initializeAppLogic(user);
            } else {
                authOverlay.style.display = 'flex';
                appContent.classList.add('hidden');
                loader.style.display = 'none';
            }
        });

        async function initializeAppLogic(user) {
            document.getElementById('user-email').textContent = user.email;
            
            const decksCollectionRef = collection(db, "users", user.uid, "decks");
            
            // Sync default decks
            const batch = writeBatch(db);
            for (const deckId in defaultDecks) {
                const deckData = defaultDecks[deckId];
                const deckRef = doc(db, "users", user.uid, "decks", deckId);
                batch.set(deckRef, { name: deckData.name, isDefault: true });
                deckData.cards.forEach(cardData => {
                    const cardRef = doc(db, "users", user.uid, "decks", deckId, "cards", cardData.id);
                    batch.set(cardRef, cardData);
                });
            }
            await batch.commit();


            // Load all user decks
            const finalDecksSnapshot = await getDocs(query(decksCollectionRef));
            userDecks = {};
            for (const deckDoc of finalDecksSnapshot.docs) {
                const deckId = deckDoc.id;
                const cardsCollectionRef = collection(db, "users", user.uid, "decks", deckId, "cards");
                const cardsSnapshot = await getDocs(query(cardsCollectionRef));
                userDecks[deckId] = {
                    ...deckDoc.data(),
                    id: deckId,
                    cards: cardsSnapshot.docs.map(d => ({ id: d.id, ...d.data() }))
                };
                userDecks[deckId].cards.sort((a, b) => (a.id || '').localeCompare(b.id || ''));
            }
            
            populateDeckSidebars();
            const firstDeckId = Object.keys(userDecks)[0];
            if (firstDeckId) {
                await loadDeck(firstDeckId);
            }
            
            loader.style.display = 'none';
            appContent.classList.remove('hidden');
        }
        
        async function loadDeck(deckId) {
            currentDeckId = deckId;
            deckTitle.textContent = userDecks[deckId].name;
            isReviewMode = false;
            reviewModeBtn.classList.remove('active');
            reviewModeBtn.textContent = "Révision Intelligente";

            document.querySelectorAll('.deck-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll(`.deck-btn[data-deck-id="${deckId}"]`).forEach(btn => btn.classList.add('active'));

            updateVisibleCards();
            updateDashboard();
            updateCardDisplay();
        }

        function populateDeckSidebars() {
            deckSidebarDesktop.innerHTML = '';
            deckSidebarMobile.innerHTML = '';
            const sortedDecks = Object.values(userDecks).sort((a,b) => a.name.localeCompare(b.name));

            for (const deckData of sortedDecks) {
                const deckName = deckData.name;
                const deckId = deckData.id;
                
                const buttonHtml = `
                    <span class="flex-grow">${deckName}</span>
                    ${!deckData.isDefault ? `<button class="delete-deck-btn p-1 rounded-full hover:bg-red-500/50 flex-shrink-0"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="pointer-events-none"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>` : ''}
                `;

                const buttonDesktop = document.createElement('button');
                buttonDesktop.dataset.deckId = deckId;
                buttonDesktop.className = 'deck-btn w-full text-left p-3 rounded-lg text-gray-300 hover:bg-gray-700 transition flex items-center justify-between';
                buttonDesktop.innerHTML = buttonHtml;
                deckSidebarDesktop.appendChild(buttonDesktop);

                const buttonMobile = document.createElement('button');
                buttonMobile.dataset.deckId = deckId;
                buttonMobile.className = 'deck-btn flex-shrink-0 px-4 py-2 rounded-lg text-sm text-gray-300 bg-gray-700 hover:bg-gray-600 transition flex items-center justify-between space-x-2';
                buttonMobile.innerHTML = buttonHtml;
                deckSidebarMobile.appendChild(buttonMobile);
            }
        }
        
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function updateVisibleCards() {
            const currentDeck = userDecks[currentDeckId];
            if (!currentDeck) return;

            if (isReviewMode) {
                const toReview = currentDeck.cards.filter(c => c.status === 'learning' || c.status === 'new' || !c.status);
                const mastered = currentDeck.cards.filter(c => c.status === 'mastered');
                
                shuffleArray(toReview);
                shuffleArray(mastered);

                let reviewQuiz = [];
                const masteredCount = 5;
                const toReviewCount = 15;

                reviewQuiz = reviewQuiz.concat(mastered.slice(0, masteredCount));
                reviewQuiz = reviewQuiz.concat(toReview.slice(0, toReviewCount));
                
                // Fill up to 20 cards if not enough from the primary selection
                if (reviewQuiz.length < 20) {
                    const remainingMastered = mastered.slice(masteredCount);
                    const needed = 20 - reviewQuiz.length;
                    reviewQuiz = reviewQuiz.concat(remainingMastered.slice(0, needed));
                }

                shuffleArray(reviewQuiz);
                visibleCards = reviewQuiz.slice(0, 20);

            } else {
                visibleCards = [...currentDeck.cards];
            }
            currentCardIndex = 0;
        }

        function updateDashboard() {
            const currentDeck = userDecks[currentDeckId];
            if (!currentDeck) {
                document.getElementById('mastered-count').textContent = 0;
                document.getElementById('learning-count').textContent = 0;
                document.getElementById('new-count').textContent = 0;
                return;
            };
            document.getElementById('mastered-count').textContent = currentDeck.cards.filter(c => c.status === 'mastered').length;
            document.getElementById('learning-count').textContent = currentDeck.cards.filter(c => c.status === 'learning').length;
            document.getElementById('new-count').textContent = currentDeck.cards.filter(c => c.status === 'new' || !c.status).length;
        }

        function updateCardDisplay() {
            const showNavButtons = !isReviewMode;
            prevBtn.style.visibility = showNavButtons ? 'visible' : 'hidden';
            nextBtn.style.visibility = showNavButtons ? 'visible' : 'hidden';

            card.classList.remove('is-flipped');
            
            setTimeout(() => {
                if (!currentDeckId || !userDecks[currentDeckId] || visibleCards.length === 0) {
                    cardFront.innerHTML = `<h2 class="text-xl md:text-2xl font-bold text-center p-4">${isReviewMode ? 'Aucune carte à réviser !' : 'Paquet vide.'}</h2>`;
                    cardBack.innerHTML = '';
                    progressText.textContent = '0 / 0';
                    card.classList.remove('status-new', 'status-learning', 'status-mastered');
                    prevBtn.disabled = true;
                    nextBtn.disabled = true;
                    return;
                }

                const currentCardData = visibleCards[currentCardIndex];
                cardFront.innerHTML = `<h2 class="text-4xl md:text-6xl font-bold korean-font">${currentCardData.hangul}</h2>`;
                cardBack.innerHTML = `
                    <h3 class="text-3xl md:text-5xl font-bold">${currentCardData.french}</h3>
                    <p class="text-lg md:text-xl mt-2 text-gray-300">${currentCardData.romanization}</p>
                `;

                card.classList.remove('status-new', 'status-learning', 'status-mastered');
                card.classList.add(`status-${currentCardData.status || 'new'}`);

                progressText.textContent = `Carte ${currentCardIndex + 1} sur ${visibleCards.length}`;
                prevBtn.disabled = currentCardIndex === 0;
                nextBtn.disabled = currentCardIndex === visibleCards.length - 1;
            }, 150);
        }

        async function updateCardStatus(newStatus) {
            if (!auth.currentUser || visibleCards.length === 0) return;
            const cardId = visibleCards[currentCardIndex].id;
            
            const cardInFullDeck = userDecks[currentDeckId].cards.find(c => c.id === cardId);
            if(cardInFullDeck) cardInFullDeck.status = newStatus;
            
            card.classList.remove('status-new', 'status-learning', 'status-mastered');
            card.classList.add(`status-${newStatus}`);
            updateDashboard();

            const docRef = doc(db, "users", auth.currentUser.uid, "decks", currentDeckId, "cards", cardId);
            try {
                await setDoc(docRef, { status: newStatus }, { merge: true });
            } catch (error) {
                console.error("Erreur de mise à jour:", error);
            }
        }

        function setupEventListeners() {
            card.addEventListener('click', () => {
                const isFlipped = card.classList.contains('is-flipped');
                if (isReviewMode) {
                    if (isFlipped) {
                        if (currentCardIndex < visibleCards.length - 1) {
                            currentCardIndex++;
                            updateCardDisplay();
                        } else {
                            isReviewMode = false;
                            reviewModeBtn.classList.remove('active');
                            reviewModeBtn.textContent = 'Révision Intelligente';
                            updateVisibleCards();
                            updateCardDisplay();
                        }
                    } else {
                        card.classList.add('is-flipped');
                    }
                } else {
                    card.classList.toggle('is-flipped');
                }
            });

            nextBtn.addEventListener('click', () => {
                if (currentCardIndex < visibleCards.length - 1) {
                    currentCardIndex++;
                    updateCardDisplay();
                }
            });
            prevBtn.addEventListener('click', () => {
                if (currentCardIndex > 0) {
                    currentCardIndex--;
                    updateCardDisplay();
                }
            });
            
            [deckSidebarDesktop, deckSidebarMobile].forEach(sidebar => {
                sidebar.addEventListener('click', (e) => {
                    const deckBtn = e.target.closest('.deck-btn');
                    const deleteBtn = e.target.closest('.delete-deck-btn');

                    if (deleteBtn) {
                        e.stopPropagation();
                        const deckIdToDelete = deckBtn.dataset.deckId;
                        openDeleteConfirmation(deckIdToDelete);
                    } else if (deckBtn) {
                        loadDeck(deckBtn.dataset.deckId);
                    }
                });
            });
            
            reviewModeBtn.addEventListener('click', () => {
                isReviewMode = !isReviewMode;
                reviewModeBtn.classList.toggle('active', isReviewMode);
                if(isReviewMode) {
                    reviewModeBtn.textContent = "Quitter la révision";
                } else {
                    reviewModeBtn.textContent = "Révision Intelligente";
                }
                updateVisibleCards();
                updateCardDisplay();
            });

            document.getElementById('status-buttons').addEventListener('click', (e) => {
                const statusBtn = e.target.closest('.status-btn');
                if (statusBtn) updateCardStatus(statusBtn.dataset.status);
            });
            
            // --- Modal Listeners ---
            document.getElementById('add-deck-btn').addEventListener('click', () => addDeckModal.classList.remove('hidden'));
            document.getElementById('cancel-deck-btn').addEventListener('click', () => addDeckModal.classList.add('hidden'));
            document.getElementById('save-deck-btn').addEventListener('click', saveNewDeck);
            
            document.getElementById('add-card-btn').addEventListener('click', () => addCardModal.classList.remove('hidden'));
            document.getElementById('cancel-card-btn').addEventListener('click', () => addCardModal.classList.add('hidden'));
            document.getElementById('save-card-btn').addEventListener('click', saveNewCard);

            document.getElementById('cancel-delete-deck-btn').addEventListener('click', () => deleteDeckModal.classList.add('hidden'));
            
            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('signup-form').addEventListener('submit', handleSignup);
        }
        
        function openDeleteConfirmation(deckId) {
            deleteDeckModal.classList.remove('hidden');
            confirmDeleteBtn.onclick = () => deleteDeck(deckId);
        }

        async function deleteDeck(deckId) {
            // Delete all cards in the subcollection
            const cardsRef = collection(db, "users", auth.currentUser.uid, "decks", deckId, "cards");
            const cardsSnapshot = await getDocs(cardsRef);
            const batch = writeBatch(db);
            cardsSnapshot.forEach(doc => {
                batch.delete(doc.ref);
            });
            
            // Delete the deck document itself
            const deckRef = doc(db, "users", auth.currentUser.uid, "decks", deckId);
            batch.delete(deckRef);

            await batch.commit();

            // Update UI
            delete userDecks[deckId];
            deleteDeckModal.classList.add('hidden');
            populateDeckSidebars();
            
            // If the deleted deck was the current one, load the first available deck
            if (currentDeckId === deckId) {
                const firstDeckId = Object.keys(userDecks)[0];
                if (firstDeckId) {
                    loadDeck(firstDeckId);
                } else {
                    // Handle case where no decks are left
                    deckTitle.textContent = "Aucun paquet";
                    currentDeckId = null;
                    updateDashboard();
                    updateCardDisplay();
                }
            }
        }

        async function saveNewDeck() {
            const deckNameInput = document.getElementById('new-deck-name');
            const deckName = deckNameInput.value.trim();
            if (!deckName) return;
            
            const newDeckRef = doc(collection(db, "users", auth.currentUser.uid, "decks"));
            await setDoc(newDeckRef, { name: deckName, isDefault: false });
            
            userDecks[newDeckRef.id] = { id: newDeckRef.id, name: deckName, isDefault: false, cards: [] };
            
            populateDeckSidebars();
            loadDeck(newDeckRef.id);
            
            deckNameInput.value = '';
            addDeckModal.classList.add('hidden');
        }
        
        async function saveNewCard() {
            const frenchInput = document.getElementById('new-card-french');
            const hangulInput = document.getElementById('new-card-hangul');
            const romanizationInput = document.getElementById('new-card-romanization');
            
            const newCard = {
                french: frenchInput.value.trim(),
                hangul: hangulInput.value.trim(),
                romanization: romanizationInput.value.trim(),
                status: 'new'
            };
            
            if (!newCard.french || !newCard.hangul) return;
            
            const cardsCollectionRef = collection(db, "users", auth.currentUser.uid, "decks", currentDeckId, "cards");
            const newCardRef = await addDoc(cardsCollectionRef, newCard);
            
            newCard.id = newCardRef.id;
            userDecks[currentDeckId].cards.push(newCard);
            
            updateVisibleCards();
            updateDashboard();
            updateCardDisplay();
            
            frenchInput.value = '';
            hangulInput.value = '';
            romanizationInput.value = '';
            addCardModal.classList.add('hidden');
        }

        async function handleLogin(e) { 
            e.preventDefault();
            const button = e.target.querySelector('button[type="submit"]');
            button.classList.add('btn-loading');
            try { 
                await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-password').value); 
            } catch (error) { 
                handleAuthError(error); 
            } finally {
                button.classList.remove('btn-loading');
            }
        }
        async function handleSignup(e) { 
            e.preventDefault(); 
            const button = e.target.querySelector('button[type="submit"]');
            button.classList.add('btn-loading');
            try { 
                await createUserWithEmailAndPassword(auth, document.getElementById('signup-email').value, document.getElementById('signup-password').value); 
            } catch (error) { 
                handleAuthError(error); 
            } finally {
                button.classList.remove('btn-loading');
            }
        }
        function handleAuthError(error) {
            const errorElement = document.getElementById('auth-error');
            switch (error.code) {
                case 'auth/wrong-password': case 'auth/invalid-credential': errorElement.textContent = 'Mot de passe ou e-mail incorrect.'; break;
                case 'auth/user-not-found': errorElement.textContent = 'Aucun compte trouvé pour cet e-mail.'; break;
                case 'auth/weak-password': errorElement.textContent = 'Le mot de passe doit faire au moins 6 caractères.'; break;
                case 'auth/email-already-in-use': errorElement.textContent = 'Cette adresse e-mail est déjà utilisée.'; break;
                default: errorElement.textContent = 'Une erreur est survenue.';
            }
        }
        
        setupEventListeners();
    </script>
</body>
</html>
